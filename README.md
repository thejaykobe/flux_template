# flux_template
This repo is a bare bones template for using flux2

The purpose of this repo is to provide a template to run flux2 from a git repo on kubernetes.

I will try and make this READ.ME as undertandable as I can, and if you want more detail or clarification please visit the flux2 docs.

- Steps in order - 

clone this repo

create a new folder in a new location for the cluster you're going to deploy

copy the contents of this repo into the new folder and open that folder in visual studio code

rename the 'envrc' file to '.envrc' - this is file holds the environmental variables for the cluster you're deploying the configs to

update the '.envrc' file line 2 to the path of your kubernetes kubeconfig

rename the file 'gitignore' to '.gitignore'

update the '.gitignore' file to add any additional files (secrets, passwords, etc) you don't want to be in your repo

rename the following files:
- 'pre-commit-config.yaml' -> '.pre-commit-config.yaml'
- 'sops.yaml' -> '.sops.yaml'
- 'yamllint.yaml' -> '.yamllint.yaml'

make sure the following applications are installed on your local computer:
- direnv 
- age - https://github.com/FiloSottile/age
- kubectl - https://kubernetes.io/docs/tasks/tools/

next we're going to create a private/public key via age to allow all necessariy variables/secrets to be encrypted in the git repo - ensure the tools above are installed

run the command 'age-keygen -o age.agekey'

take the public key that was generated by this command and put it in the '.sops.yaml' file

run the command 'cat ./age.agekey| kubectl create secret generic sops-age -n flux-system --from-file=age.agekey=/dev/stdin' - this command is putting your age.agekey into the cluster. This allows the cluster to decrypt the files to come

run the command 'kubectl apply -k ./bootstrap' -> this command is installing flux2 on the kubernetes cluster; and if you don't run this command you will get the following error later 'kustomization generation is 1, but latest observed generation is -1'

you will want to replace all '<the new folder name you made in git>' with the name of the 'new folder' from the step above - this will be how each file is referenced

edit the file './flux/flux-system/flux-cluster.yaml' and replace 'https://github.com/your-name/your-repo.git' with your repo location

if your repo is set to private do the following; otherwise delete the commented section in the file './flux/flux-system/flux-cluster.yaml'

if your repo is set to private:
- uncomment lines 12 and 13
- create a secret in your kubernetes cluster named 'basic-access-auth' 
    - the kind will be opaque
    - the first key will be 'username' the value for this will be your git username
    - the second key will be 'password' the value for this will be your git password or token
- once the key is made in kubernetes please proceed - you can either do this via kubectl or manually via some sort of gui - i will leave this to your discresion

update the file './flux/config/cluster-secrests.sops.yaml' file with any secrets you want to deploy - note there are two example secret variables there

run the command 'sops --encrypt --in-place ~/path/to/flux/config/cluster-secrets.sops.yaml' - this is going to encrypt the file so that only your age.agekey can decrypt it

the next step is you will update the following folders & files in the to whatever you need in the cluster - NOTE: i have left some examples here for you to use as a guide
- './flux/charts' - this folder houses all of the helm charts you want deployed to your cluster
- './flux/crds' - this folder houses all of the crds you want to deploy

update the folder './apps' - this folder contains all of the apps you want to deploy from the './flux/charts' or other apps that maybe don't have a helm chart; again i've left some examples in this folder 

once you've added all of the applications you want proceed

run the command 'kubectl apply -k ./flux/flux-system'

from here you cant watch the magic work and everything else should be automated

NOTE: the configs tell flux to check the repository every '1m' or 1 minutes for new updates. This means that if you push changes to your repo those changes will take effect every one minute

NOTE: if you remove or comment anything out of your configs; THOSE THINGS WILL BE REMOVED FROM YOUR CLUSTER

I will continue to add information here as I can; enjoy!!